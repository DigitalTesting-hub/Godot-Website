<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Godot 3D MP LMS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/lms.css">
    <link rel="stylesheet" href="css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="admin-page">
    <!-- Header -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">GODOT 3D MP - ADMIN</div>
                
                <!-- Desktop Navigation -->
                <div class="nav-links">
                    <a href="#dashboard" class="active">Dashboard</a>
                    <a href="#courses">Courses</a>
                    <a href="#students">Students</a>
                </div>
                
                <!-- Admin User Menu -->
                <div class="user-menu">
                    <span id="adminEmail" class="user-email">Loading...</span>
                    <button id="adminLogoutBtn" class="cta-button logout-btn">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Checking admin access...</p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <section id="dashboard" class="admin-dashboard" style="display: none;">
        <div class="container">
            <div class="admin-header">
                <h1>Admin Dashboard</h1>
                <p>Welcome to the Godot 3D MP LMS Admin Panel</p>
            </div>

            <div class="admin-stats">
                <div class="stat-card">
                    <h3>Total Students</h3>
                    <span id="totalStudents" class="stat-number">0</span>
                </div>
                <div class="stat-card">
                    <h3>Total Courses</h3>
                    <span id="totalCourses" class="stat-number">0</span>
                </div>
                <div class="stat-card">
                    <h3>Active Courses</h3>
                    <span id="activeCourses" class="stat-number">0</span>
                </div>
                <div class="stat-card">
                    <h3>Admin Status</h3>
                    <span class="stat-number">‚úÖ Active</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2>Quick Actions</h2>
                <div class="action-grid">
                    <button class="action-btn" onclick="showSection('courses')">
                        <span class="action-icon">üìö</span>
                        <span>Manage Courses</span>
                    </button>
                    <button class="action-btn" onclick="showSection('students')">
                        <span class="action-icon">üë•</span>
                        <span>Manage Students</span>
                    </button>
                    <button class="action-btn" onclick="openCourseModal()">
                        <span class="action-icon">‚ûï</span>
                        <span>Add New Course</span>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Courses Management -->
    <section id="courses" class="admin-section" style="display: none;">
        <div class="container">
            <div class="section-header">
                <h2>Course Management</h2>
                <button class="cta-button" onclick="openCourseModal()">+ Add New Course</button>
            </div>

            <div class="courses-list" id="adminCoursesList">
                <div class="placeholder-message">
                    <p>Loading courses...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Students Management -->
    <section id="students" class="admin-section" style="display: none;">
        <div class="container">
            <div class="section-header">
                <h2>Student Management</h2>
                <div class="search-box">
                    <input type="text" id="studentSearch" placeholder="Search students by email..." onkeyup="adminPanel.searchStudents(this.value)">
                </div>
            </div>

            <div class="students-list" id="studentsList">
                <div class="placeholder-message">
                    <p>Loading students...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Course Modal -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="courseModalTitle">Add New Course</h3>
                <button class="close-btn" onclick="closeCourseModal()">‚úï</button>
            </div>
            <form id="courseForm" class="modal-form">
                <input type="hidden" id="courseId" value="">
                <div class="form-group">
                    <label for="courseTitle">Course Title *</label>
                    <input type="text" id="courseTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="courseDescription">Description *</label>
                    <textarea id="courseDescription" rows="4" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="courseTier">Required Tier *</label>
                        <select id="courseTier" required>
                            <option value="free">Free</option>
                            <option value="basic">Basic</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="coursePrice">Price ($) *</label>
                        <input type="number" id="coursePrice" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="courseStatus">Status</label>
                    <select id="courseStatus">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeCourseModal()">Cancel</button>
                    <button type="submit" class="cta-button">Save Course</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chapter Modal -->
    <div id="chapterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="chapterModalTitle">Add New Chapter</h3>
                <button class="close-btn" onclick="closeChapterModal()">‚úï</button>
            </div>
            <form id="chapterForm" class="modal-form">
                <input type="hidden" id="chapterId" value="">
                <input type="hidden" id="chapterCourseId" value="">
                <div class="form-group">
                    <label for="chapterTitle">Chapter Title *</label>
                    <input type="text" id="chapterTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="chapterDescription">Description</label>
                    <textarea id="chapterDescription" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="chapterOrder">Order Index *</label>
                        <input type="number" id="chapterOrder" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="chapterVideoUrl">Mux Video URL</label>
                        <input type="url" id="chapterVideoUrl" placeholder="https://stream.mux.com/...">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeChapterModal()">Cancel</button>
                    <button type="submit" class="cta-button">Save Chapter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Student Edit Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Student</h3>
                <button class="close-btn" onclick="closeStudentModal()">‚úï</button>
            </div>
            <form id="studentForm" class="modal-form">
                <input type="hidden" id="studentId" value="">
                <div class="form-group">
                    <label for="studentEmail">Email</label>
                    <input type="email" id="studentEmail" readonly>
                </div>
                
                <div class="form-group">
                    <label for="studentTier">Subscription Tier *</label>
                    <select id="studentTier" required>
                        <option value="free">Free</option>
                        <option value="basic">Basic</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeStudentModal()">Cancel</button>
                    <button type="submit" class="cta-button">Update Student</button>
                </div>
            </form>
        </div>
    </div>

    <div id="adminMessage" class="form-message" style="display: none;"></div>

    <script>
        // üîÑ CHANGE THESE TO YOUR NEW SUPABASE URL & ANON KEY
        const SUPABASE_URL = 'YOUR_NEW_SUPABASE_URL_HERE';
        const SUPABASE_ANON_KEY = 'YOUR_NEW_SUPABASE_ANON_KEY_HERE';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        class AdminPanel {
            constructor() {
                this.currentUser = null;
                this.courses = [];
                this.students = [];
                this.chapters = [];
                this.isAdmin = false;
                this.init();
            }

            async init() {
                console.log('üöÄ Admin panel initializing...');
                await this.checkAdminAuth();
            }

            async checkAdminAuth() {
                console.log('üîê Checking admin authentication...');
                
                try {
                    // First check if we have a session
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    
                    if (sessionError) {
                        console.error('Session error:', sessionError);
                        this.redirectToLogin('Authentication error');
                        return;
                    }

                    if (!session) {
                        console.log('‚ùå No active session found');
                        this.redirectToLogin('Please login to access admin panel');
                        return;
                    }

                    console.log('‚úÖ User session found:', session.user.email);
                    this.currentUser = session.user;
                    
                    // Check if user is admin using simple email check
                    this.isAdmin = await this.checkAdminAccess(session.user.email);
                    
                    if (!this.isAdmin) {
                        console.log('‚ùå Access denied - not admin:', session.user.email);
                        this.showAccessDenied();
                        return;
                    }

                    console.log('üéâ Admin access granted to:', session.user.email);
                    
                    // User is admin, proceed to load dashboard
                    document.getElementById('adminEmail').textContent = session.user.email;
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    this.setupEventListeners();
                    await this.loadDashboardData();
                    this.renderDashboard();

                } catch (error) {
                    console.error('Auth check error:', error);
                    this.redirectToLogin('Authentication failed');
                }
            }

            async checkAdminAccess(email) {
                try {
                    // Simple email-based admin check
                    const adminEmails = ['graphicyin@gmail.com'];
                    const isAdmin = adminEmails.includes(email.toLowerCase());
                    
                    console.log('üõ°Ô∏è Admin check for', email, ':', isAdmin);
                    
                    // Additional check: Verify user exists in admin_roles table
                    if (isAdmin) {
                        const { data: adminRole, error } = await supabase
                            .from('admin_roles')
                            .select('*')
                            .eq('user_id', this.currentUser.id)
                            .single();

                        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                            console.error('Admin role check error:', error);
                        }
                        
                        console.log('üìã Admin role in database:', adminRole);
                    }
                    
                    return isAdmin;
                } catch (error) {
                    console.error('Admin access check error:', error);
                    return false;
                }
            }

            showAccessDenied() {
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="loading-content">
                        <div style="color: #ff6b35; font-size: 3rem;">‚õî</div>
                        <h2>Access Denied</h2>
                        <p>You don't have admin privileges.</p>
                        <button onclick="window.location.href='course.html'" class="cta-button">
                            Go to Course Page
                        </button>
                        <button onclick="adminPanel.logout()" class="btn-secondary" style="margin-top: 1rem;">
                            Logout
                        </button>
                    </div>
                `;
            }

            redirectToLogin(message = '') {
                console.log('üîÄ Redirecting to login:', message);
                if (message) {
                    localStorage.setItem('adminLoginMessage', message);
                }
                window.location.href = 'admin-login.html';
            }

            setupEventListeners() {
                // Logout button
                document.getElementById('adminLogoutBtn').addEventListener('click', () => this.logout());

                // Form submissions
                document.getElementById('courseForm').addEventListener('submit', (e) => this.handleCourseSubmit(e));
                document.getElementById('chapterForm').addEventListener('submit', (e) => this.handleChapterSubmit(e));
                document.getElementById('studentForm').addEventListener('submit', (e) => this.handleStudentSubmit(e));

                // Auth state changes
                supabase.auth.onAuthStateChange((event, session) => {
                    console.log('Auth state changed:', event);
                    if (event === 'SIGNED_OUT') {
                        this.redirectToLogin('You have been logged out');
                    }
                });
            }

            async loadDashboardData() {
                await this.loadCourses();
                await this.loadStudents();
                await this.loadChapters();
                this.updateStats();
            }

            async loadCourses() {
                try {
                    const { data, error } = await supabase
                        .from('courses')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    this.courses = data || [];
                    console.log('üìö Loaded courses:', this.courses);
                } catch (error) {
                    console.error('Error loading courses:', error);
                    this.courses = [];
                }
            }

            async loadStudents() {
                try {
                    console.log('üë• Loading students from userprofile...');
                    
                    const { data: userprofiles, error } = await supabase
                        .from('userprofile')
                        .select('*');

                    if (error) throw error;

                    this.students = userprofiles.map(profile => ({
                        id: profile.id,
                        email: profile.email,
                        created_at: profile.created_at,
                        subscription_tier: profile.subscription_tier || 'free'
                    }));

                    console.log('‚úÖ Loaded students:', this.students);
                } catch (error) {
                    console.error('Error loading students:', error);
                    this.students = [];
                }
            }

            async loadChapters() {
                try {
                    const { data, error } = await supabase
                        .from('chapters')
                        .select('*')
                        .order('order_index', { ascending: true });

                    if (error) throw error;
                    this.chapters = data || [];
                    console.log('üìñ Loaded chapters:', this.chapters);
                } catch (error) {
                    console.error('Error loading chapters:', error);
                    this.chapters = [];
                }
            }

            updateStats() {
                const totalStudents = this.students.length;
                const totalCourses = this.courses.length;
                const activeCourses = this.courses.filter(c => c.status === 'active').length;

                document.getElementById('totalStudents').textContent = totalStudents;
                document.getElementById('totalCourses').textContent = totalCourses;
                document.getElementById('activeCourses').textContent = activeCourses;
            }

            renderDashboard() {
                this.renderCourses();
                this.renderStudents();
            }

            renderCourses() {
                const container = document.getElementById('adminCoursesList');
                if (!container) return;

                if (this.courses.length === 0) {
                    container.innerHTML = `
                        <div class="placeholder-message">
                            <p>No courses found. Click "Add New Course" to create your first course.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.courses.map(course => {
                    const courseChapters = this.chapters.filter(ch => ch.course_id === course.id);
                    
                    return `
                        <div class="course-item">
                            <div class="course-header">
                                <div class="course-info">
                                    <h3>${course.title}</h3>
                                    <div class="course-meta">
                                        <span class="course-tier ${course.required_tier}">${course.required_tier.toUpperCase()} TIER</span>
                                        <span class="course-price">$${course.price}</span>
                                        <span class="course-status ${course.status}">${course.status.toUpperCase()}</span>
                                    </div>
                                </div>
                                <div class="course-actions">
                                    <button class="btn-small" onclick="adminPanel.editCourse('${course.id}')">Edit</button>
                                    <button class="btn-small btn-secondary" onclick="adminPanel.toggleCourseStatus('${course.id}')">
                                        ${course.status === 'active' ? 'Deactivate' : 'Activate'}
                                    </button>
                                    <button class="btn-small" onclick="adminPanel.openChapterModal('${course.id}')">+ Add Chapter</button>
                                    <button class="btn-small btn-danger" onclick="adminPanel.deleteCourse('${course.id}')">Delete</button>
                                </div>
                            </div>
                            <div class="course-description">
                                <p>${course.description}</p>
                            </div>
                            <div class="course-chapters">
                                <h4>Chapters (${courseChapters.length})</h4>
                                ${courseChapters.length > 0 ? courseChapters.map(chapter => `
                                    <div class="chapter-item">
                                        <div class="chapter-header">
                                            <div class="chapter-info">
                                                <h5>${chapter.order_index}. ${chapter.title}</h5>
                                                ${chapter.video_url ? '<span class="has-video">üé• Has Video</span>' : ''}
                                            </div>
                                            <div class="chapter-actions">
                                                <button class="btn-small" onclick="adminPanel.editChapter('${chapter.id}')">Edit</button>
                                                <button class="btn-small btn-danger" onclick="adminPanel.deleteChapter('${chapter.id}')">Delete</button>
                                            </div>
                                        </div>
                                        ${chapter.description ? `<p class="chapter-description">${chapter.description}</p>` : ''}
                                    </div>
                                `).join('') : '<p class="no-chapters">No chapters added yet.</p>'}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderStudents() {
                const container = document.getElementById('studentsList');
                if (!container) return;

                if (this.students.length === 0) {
                    container.innerHTML = `
                        <div class="placeholder-message">
                            <p>No students found yet. Students will appear here when they sign up.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.students.map(student => {
                    return `
                        <div class="student-item">
                            <div class="student-info">
                                <h3>${student.email}</h3>
                                <div class="student-meta">
                                    <span class="tier-badge ${student.subscription_tier}">${student.subscription_tier.toUpperCase()}</span>
                                    <span>Joined: ${new Date(student.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="student-actions">
                                <button class="btn-small" onclick="adminPanel.editStudent('${student.id}')">Edit Tier</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // ... rest of the methods remain the same as previous version ...
            // [Include all the other methods from the previous admin.html code here]
            // handleCourseSubmit, handleChapterSubmit, handleStudentSubmit, editCourse, editChapter, editStudent, deleteCourse, deleteChapter, toggleCourseStatus, searchStudents, openChapterModal, logout, showMessage

        }

        // Global functions for modals and navigation
        function showSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
            
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.nav-links a[href="#${sectionId}"]`).classList.add('active');
        }

        function openCourseModal(courseId = null) {
            if (!courseId) {
                document.getElementById('courseModalTitle').textContent = 'Add New Course';
                document.getElementById('courseForm').reset();
                document.getElementById('courseId').value = '';
            }
            document.getElementById('courseModal').classList.add('active');
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
        }

        function openChapterModal() {
            document.getElementById('chapterModal').classList.add('active');
        }

        function closeChapterModal() {
            document.getElementById('chapterModal').classList.remove('active');
        }

        function openStudentModal() {
            document.getElementById('studentModal').classList.add('active');
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('active');
        }

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            window.adminPanel = new AdminPanel();
        });
    </script>

    <style>
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            text-align: center;
            color: var(--light);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
