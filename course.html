<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses - Godot 3D MP LMS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/lms.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Mux Player for video content -->
    <script src="https://cdn.jsdelivr.net/npm/@mux/mux-player"></script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">GODOT 3D MP</div>
                
                <!-- Desktop Navigation -->
                <div class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="#dashboard">Dashboard</a>
                    <a href="#progress">My Progress</a>
                </div>
                
                <!-- Desktop User Menu -->
                <div class="user-menu">
                    <span id="userEmail" class="user-email"></span>
                    <span id="userTier" class="user-tier"></span>
                    <button id="logoutBtn" class="cta-button logout-btn">Logout</button>
                </div>
                
                <!-- Mobile Menu Button -->
                <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
            </nav>
        </div>
        
        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <div class="mobile-menu-logo">GODOT 3D MP</div>
                <button class="mobile-close-btn" id="mobileCloseBtn">‚úï</button>
            </div>
            
            <div class="mobile-nav-links">
                <a href="index.html" onclick="closeMobileMenu()">Home</a>
                <a href="#dashboard" onclick="closeMobileMenu()">Dashboard</a>
                <a href="#progress" onclick="closeMobileMenu()">My Progress</a>
                
                <!-- Mobile User Info -->
                <div class="mobile-user-menu">
                    <div class="mobile-user-email" id="mobileUserEmail"></div>
                    <div class="mobile-user-tier" id="mobileUserTier"></div>
                    <button class="mobile-logout-btn" id="mobileLogoutBtn">Logout</button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu Overlay -->
        <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    </header>

    <!-- Authentication Required Message -->
    <div id="authRequired" class="auth-required-message">
        <div class="container">
            <div class="auth-message">
                <h2>Authentication Required</h2>
                <p>Please log in to access the course content.</p>
                <a href="login.html" class="cta-button">Login / Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Upgrade Banner -->
    <div id="upgradeBanner" class="upgrade-banner" style="display: none;">
        <div class="container">
            <div class="banner-content">
                <span>üöÄ Upgrade to Premium for full access to all courses and features!</span>
                <button class="cta-button small" onclick="showUpgradeModal()">Upgrade Now</button>
            </div>
        </div>
    </div>

    <!-- LMS Dashboard -->
    <section id="dashboard" class="lms-dashboard" style="display: none;">
        <div class="container">
            <div class="dashboard-header">
                <h1>Godot Multiplayer Courses</h1>
                <div class="user-info">
                    <p>Email: <span id="displayEmail"></span></p>
                    <p>Tier: <strong id="displayTier"></strong></p>
                </div>
            </div>

            <!-- Courses View -->
            <div id="coursesView" class="courses-view">
                <h2>Available Courses</h2>
                <div class="subscription-info">
                    <p>Current Tier: <strong id="currentTier">Free</strong></p>
                    <p>Purchased Courses: <strong id="purchasedCount">0</strong></p>
                    <p>Completed Modules: <strong id="completedCount">0</strong></p>
                </div>
                <div id="coursesContainer" class="courses-grid">
                    <!-- Courses will be loaded here -->
                </div>
            </div>

            <!-- Course Details View -->
            <div id="courseDetailsView" class="course-details-view" style="display: none;">
                <button id="backToCourses" class="back-button" onclick="backToCourses()">‚Üê Back to Courses</button>
                <div class="course-details-container">
                    <div class="course-header-details">
                        <h2 id="courseDetailTitle"></h2>
                        <p id="courseDetailDescription"></p>
                        <div class="course-meta-details">
                            <span class="course-tier-badge" id="courseDetailTier"></span>
                            <span class="course-price" id="courseDetailPrice"></span>
                            <span class="progress-badge" id="courseProgressBadge">0% Complete</span>
                        </div>
                    </div>

                    <!-- Video Player Section -->
                    <div id="videoSection" class="video-section" style="display: none;">
                        <div class="video-player-container">
                            <div id="videoPlayer" class="video-player">
                                <!-- Mux video player will be loaded here -->
                            </div>
                            <div class="video-controls">
                                <button id="prevModule" class="btn-secondary">‚Üê Previous</button>
                                <div class="module-info">
                                    <h3 id="currentModuleTitle">Module Title</h3>
                                    <div class="module-meta">
                                        <span id="moduleDuration">Duration: N/A</span>
                                        <span id="moduleTier">Tier: basic</span>
                                        <span id="moduleStatus">Status: Not Started</span>
                                    </div>
                                    <p id="moduleDescription">Module description will appear here.</p>
                                </div>
                                <div class="video-actions">
                                    <button id="completeModule" class="cta-button">Mark Complete</button>
                                    <button id="nextModule" class="btn-secondary">Next ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="course-content">
                        <!-- Modules Section -->
                        <div class="modules-section">
                            <h3>Course Content</h3>
                            <div id="modulesList" class="modules-list">
                                <!-- Modules will be loaded here -->
                            </div>
                        </div>

                        <!-- Downloads Section -->
                        <div class="downloads-section">
                            <h3>Resources & Downloads</h3>
                            <div id="downloadsList" class="downloads-list">
                                <!-- Downloads will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Progress Overview -->
    <section id="progress" class="progress-overview" style="display: none;">
        <div class="container">
            <div class="progress-grid">
                <div class="progress-card main-progress">
                    <h3>Learning Progress</h3>
                    <div class="progress-circle-container">
                        <svg class="progress-circle" width="120" height="120" viewBox="0 0 120 120">
                            <circle class="progress-circle-bg" cx="60" cy="60" r="54" stroke-width="6"/>
                            <circle id="completionCircle" class="progress-circle-fill" cx="60" cy="60" r="54" stroke-width="6" 
                                    stroke-dasharray="339.292" stroke-dashoffset="339.292" transform="rotate(-90 60 60)"/>
                            <text class="progress-text" x="60" y="60" text-anchor="middle" dy="7">
                                <tspan id="completionPercent" class="progress-percent">0%</tspan>
                                <tspan class="progress-label" x="60" dy="20">Complete</tspan>
                            </text>
                        </svg>
                    </div>
                    <div class="progress-stats">
                        <div class="stat-item">
                            <span class="stat-value" id="displayProgress">0%</span>
                            <span class="stat-label">Overall Progress</span>
                        </div>
                    </div>
                </div>

                <div class="progress-card">
                    <h3>Recent Activity</h3>
                    <div id="userActivityList" class="activity-list">
                        <!-- User activity will be loaded here -->
                    </div>
                </div>

                <div class="progress-card">
                    <h3>Course Progress</h3>
                    <div id="courseProgressList" class="course-progress-list">
                        <!-- Course progress will be loaded here -->
                    </div>
                </div>

                <div class="progress-card">
                    <h3>Your Subscription</h3>
                    <div class="subscription-status">
                        <div class="tier-info">
                            <span class="tier-label">Current Tier:</span>
                            <span id="progressTier" class="tier-value">Free</span>
                        </div>
                        <div class="upgrade-options">
                            <!-- Upgrade options will be dynamically loaded -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upgrade Your Account</h3>
                <button class="modal-close" onclick="closeUpgradeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="upgrade-options-modal">
                    <div class="upgrade-option">
                        <h4>Basic Tier</h4>
                        <p>Access to basic courses and resources</p>
                        <button class="cta-button" onclick="processUpgrade('basic')">Upgrade to Basic</button>
                    </div>
                    <div class="upgrade-option premium">
                        <h4>Premium Tier</h4>
                        <p>Full access to all courses, premium content, and downloads</p>
                        <button class="cta-button premium" onclick="processUpgrade('premium')">Upgrade to Premium</button>
                    </div>
                </div>
                <div class="manual-upgrade">
                    <p>Prefer manual payment?</p>
                    <button class="btn-secondary" onclick="processUpgrade('manual')">Contact via WhatsApp</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced LMS Manager with Progress Tracking and Tier-based Access
        class LMSManager {
            constructor() {
                this.currentUser = null;
                this.userProfile = null;
                this.courses = [];
                this.userCourses = [];
                this.modules = [];
                this.downloads = [];
                this.userProgress = {};
                this.currentCourse = null;
                this.currentModule = null;
                this.userActivity = [];
                this.init();
            }

            async init() {
                await this.checkAuthState();
                this.setupEventListeners();
            }

            async checkAuthState() {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                const authRequired = document.getElementById('authRequired');
                const dashboard = document.getElementById('dashboard');
                const progressSection = document.getElementById('progress');
                const userEmail = document.getElementById('userEmail');
                const displayEmail = document.getElementById('displayEmail');
                const mobileUserEmail = document.getElementById('mobileUserEmail');

                if (session && session.user) {
                    this.currentUser = session.user;
                    authRequired.style.display = 'none';
                    dashboard.style.display = 'block';
                    progressSection.style.display = 'block';
                    
                    userEmail.textContent = session.user.email;
                    displayEmail.textContent = session.user.email;
                    mobileUserEmail.textContent = session.user.email;
                    
                    await this.loadUserData();
                    await this.loadCourses();
                    await this.loadUserCourses();
                    await this.loadUserProgress();
                    await this.loadUserActivity();
                    
                    this.renderCourses();
                    this.updateProgress();
                    this.checkUpgradePrompt();
                    
                } else {
                    authRequired.style.display = 'block';
                    dashboard.style.display = 'none';
                    progressSection.style.display = 'none';
                }
            }

            async loadUserData() {
                if (!this.currentUser) return;

                try {
                    const { data, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', this.currentUser.id)
                        .single();

                    if (error) {
                        // Profile not found - create new one
                        console.log('Profile not found, creating new profile...');
                        await this.createUserProfile();
                        return;
                    }

                    this.userProfile = data;
                    
                    // Update UI with user tier
                    const tier = this.userProfile.subscription_tier || 'basic';
                    document.getElementById('currentTier').textContent = tier;
                    document.getElementById('displayTier').textContent = tier;
                    document.getElementById('progressTier').textContent = tier;
                    document.getElementById('userTier').textContent = tier;
                    document.getElementById('mobileUserTier').textContent = tier;
                    
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    this.setDefaultTier();
                }
            }

            async createUserProfile() {
                try {
                    const { data, error } = await supabase
                        .from('profiles')
                        .insert([{
                            id: this.currentUser.id,
                            email: this.currentUser.email,
                            subscription_tier: 'basic',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    
                    this.userProfile = data;
                    this.updateTierUI();
                    
                } catch (error) {
                    console.error('Error creating user profile:', error);
                    this.setDefaultTier();
                }
            }

            updateTierUI() {
                if (!this.userProfile) {
                    this.setDefaultTier();
                    return;
                }

                const userTier = this.userProfile.subscription_tier?.trim();
                const displayTier = userTier && userTier !== '' ? userTier : 'basic';
                
                document.getElementById('currentTier').textContent = displayTier;
                document.getElementById('displayTier').textContent = displayTier;
                document.getElementById('progressTier').textContent = displayTier;
                document.getElementById('userTier').textContent = displayTier;
                document.getElementById('mobileUserTier').textContent = displayTier;
            }

            setDefaultTier() {
                const defaultTier = 'basic';
                document.getElementById('currentTier').textContent = defaultTier;
                document.getElementById('displayTier').textContent = defaultTier;
                document.getElementById('progressTier').textContent = defaultTier;
                document.getElementById('userTier').textContent = defaultTier;
                document.getElementById('mobileUserTier').textContent = defaultTier;
                
                this.userProfile = this.userProfile || {};
                this.userProfile.subscription_tier = defaultTier;
            }

            async loadCourses() {
                try {
                    const { data, error } = await supabase
                        .from('courses')
                        .select('*')
                        .eq('is_active', true)
                        .order('created_at');

                    if (error) throw error;
                    this.courses = data || [];
                } catch (error) {
                    console.error('Error loading courses:', error);
                    this.courses = [];
                }
            }

            async loadUserCourses() {
                if (!this.currentUser) return;

                try {
                    const { data, error } = await supabase
                        .from('user_courses')
                        .select('*')
                        .eq('user_id', this.currentUser.id)
                        .eq('payment_status', 'completed');

                    if (error) throw error;
                    this.userCourses = data || [];
                    
                    document.getElementById('purchasedCount').textContent = this.userCourses.length;
                    
                } catch (error) {
                    console.error('Error loading user courses:', error);
                    this.userCourses = [];
                }
            }

            async loadUserProgress() {
                if (!this.currentUser) return;

                try {
                    const { data, error } = await supabase
                        .from('user_progress')
                        .select('*')
                        .eq('user_id', this.currentUser.id);

                    if (error) throw error;
                    
                    this.userProgress = {};
                    data?.forEach(progress => {
                        this.userProgress[progress.module_id] = progress;
                    });

                    const completedCount = Object.values(this.userProgress).filter(p => p.completed).length;
                    document.getElementById('completedCount').textContent = completedCount;
                    
                } catch (error) {
                    console.error('Error loading user progress:', error);
                    this.userProgress = {};
                }
            }

            async loadUserActivity() {
                if (!this.currentUser) return;

                try {
                    const { data, error } = await supabase
                        .from('user_activity')
                        .select('*')
                        .eq('user_id', this.currentUser.id)
                        .order('created_at', { ascending: false })
                        .limit(10);

                    if (error) throw error;
                    this.userActivity = data || [];
                    this.renderUserActivity();
                    
                } catch (error) {
                    console.error('Error loading user activity:', error);
                    this.userActivity = [];
                }
            }

            async loadCourseModules(courseId) {
                try {
                    const { data, error } = await supabase
                        .from('course_modules')
                        .select('*')
                        .eq('course_id', courseId)
                        .order('module_order');

                    if (error) throw error;
                    this.modules = data || [];
                    
                } catch (error) {
                    console.error('Error loading modules:', error);
                    this.modules = [];
                }
            }

            async loadCourseDownloads(courseId) {
                try {
                    const { data, error } = await supabase
                        .from('course_downloads')
                        .select('*')
                        .eq('course_id', courseId)
                        .order('created_at');

                    if (error) throw error;
                    this.downloads = data || [];
                    
                } catch (error) {
                    console.error('Error loading downloads:', error);
                    this.downloads = [];
                }
            }

            setupEventListeners() {
                console.log('Setting up event listeners...');
                
                const logoutBtn = document.getElementById('logoutBtn');
                const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
                
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.logout());
                    console.log('Desktop logout button attached');
                } else {
                    console.error('Desktop logout button not found!');
                }
                
                if (mobileLogoutBtn) {
                    mobileLogoutBtn.addEventListener('click', () => this.logout());
                    console.log('Mobile logout button attached');
                } else {
                    console.error('Mobile logout button not found!');
                }
                
                // Video controls
                document.getElementById('prevModule')?.addEventListener('click', () => this.previousModule());
                document.getElementById('nextModule')?.addEventListener('click', () => this.nextModule());
                document.getElementById('completeModule')?.addEventListener('click', () => this.markModuleComplete());

                // Mobile menu
                document.getElementById('mobileMenuBtn')?.addEventListener('click', this.openMobileMenu);
                document.getElementById('mobileCloseBtn')?.addEventListener('click', closeMobileMenu);
                document.getElementById('mobileMenuOverlay')?.addEventListener('click', closeMobileMenu);
            }

            // TIER-BASED ACCESS CONTROL
            hasCourseAccess(courseId) {
                const course = this.courses.find(c => c.id === courseId);
                if (!course) return false;

                const hasPurchased = this.userCourses.some(uc => uc.course_id === courseId);
                
                const tierLevel = { 'basic': 1, 'premium': 2 };
                const userTierLevel = tierLevel[this.userProfile?.subscription_tier] || 1;
                const courseTierLevel = tierLevel[course.required_tier] || 1;
                
                return hasPurchased && userTierLevel >= courseTierLevel;
            }

            hasModuleAccess(module) {
                const tierLevel = { 'basic': 1, 'premium': 2 };
                const userTierLevel = tierLevel[this.userProfile?.subscription_tier] || 1;
                const moduleTierLevel = tierLevel[module.required_tier] || 1;
                
                return userTierLevel >= moduleTierLevel && !(module.is_premium && this.userProfile?.subscription_tier !== 'premium');
            }

            hasDownloadAccess(download) {
                if (!download.is_premium) return true;
                return this.userProfile?.subscription_tier === 'premium';
            }

            checkUpgradePrompt() {
                const upgradeBanner = document.getElementById('upgradeBanner');
                if (this.userProfile?.subscription_tier === 'basic') {
                    upgradeBanner.style.display = 'block';
                } else {
                    upgradeBanner.style.display = 'none';
                }
            }

            // COURSE RENDERING
            renderCourses() {
                const container = document.getElementById('coursesContainer');
                if (!container) return;

                container.innerHTML = this.courses.map(course => {
                    const hasAccess = this.hasCourseAccess(course.id);
                    const canPurchase = this.canPurchaseCourse(course);
                    const courseProgress = this.getCourseProgress(course.id);
                    
                    return `
                        <div class="course-card ${hasAccess ? 'unlocked' : 'locked'}">
                            ${hasAccess ? '<div class="access-badge">‚úÖ Access Granted</div>' : ''}
                            <h3>${course.title}</h3>
                            <p>${course.description}</p>
                            <div class="course-meta">
                                <span class="course-tier">${course.required_tier.toUpperCase()} TIER</span>
                                <span class="course-price">$${course.price}</span>
                                ${hasAccess ? `<span class="progress-badge">${courseProgress.percentage}% Complete</span>` : ''}
                            </div>
                            <div class="course-actions">
                                ${hasAccess ? 
                                    `<button class="cta-button" onclick="lmsManager.viewCourse('${course.id}')">Continue Learning</button>` :
                                    (canPurchase ?
                                        `<button class="cta-button purchase" onclick="lmsManager.purchaseCourse('${course.id}')">Purchase - $${course.price}</button>` :
                                        `<button class="cta-button disabled" disabled>Upgrade Tier Required</button>`
                                    )
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async viewCourse(courseId) {
                this.currentCourse = this.courses.find(c => c.id === courseId);
                if (!this.currentCourse) return;

                document.getElementById('coursesView').style.display = 'none';
                document.getElementById('courseDetailsView').style.display = 'block';

                document.getElementById('courseDetailTitle').textContent = this.currentCourse.title;
                document.getElementById('courseDetailDescription').textContent = this.currentCourse.description;
                document.getElementById('courseDetailTier').textContent = this.currentCourse.required_tier.toUpperCase() + ' TIER';
                document.getElementById('courseDetailPrice').textContent = '$' + this.currentCourse.price;

                const courseProgress = this.getCourseProgress(courseId);
                document.getElementById('courseProgressBadge').textContent = `${courseProgress.percentage}% Complete`;

                await this.loadCourseModules(courseId);
                await this.loadCourseDownloads(courseId);
                
                this.renderModules();
                this.renderDownloads();
            }

            // MODULE RENDERING AND VIDEO PLAYER
            renderModules() {
                const modulesList = document.getElementById('modulesList');
                if (!modulesList) return;

                modulesList.innerHTML = this.modules.map((module, index) => {
                    const hasAccess = this.hasModuleAccess(module);
                    const isCompleted = this.userProgress[module.id]?.completed;
                    const isActive = this.currentModule?.id === module.id;
                    
                    let status = 'locked';
                    let statusText = 'LOCKED';
                    
                    if (hasAccess) {
                        if (isCompleted) {
                            status = 'completed';
                            statusText = 'COMPLETED';
                        } else if (isActive) {
                            status = 'active';
                            statusText = 'PLAYING';
                        } else {
                            status = 'available';
                            statusText = 'AVAILABLE';
                        }
                    }

                    return `
                        <div class="module-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${!hasAccess ? 'locked' : ''}" 
                             onclick="lmsManager.selectModule('${module.id}')">
                            <div class="module-header">
                                <div class="module-info">
                                    <span class="module-number">${(index + 1).toString().padStart(2, '0')}</span>
                                    <span class="module-title">${module.title} ${!hasAccess ? 'üîí' : ''}</span>
                                    <div class="module-meta">
                                        <span class="module-duration">${module.duration || 'N/A'}</span>
                                        <span>Tier: ${module.required_tier}</span>
                                        ${module.is_premium ? '<span class="course-tier">PREMIUM</span>' : ''}
                                    </div>
                                </div>
                                <span class="module-status status-${status}">${statusText}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async selectModule(moduleId) {
                const module = this.modules.find(m => m.id === moduleId);
                if (!module || !this.hasModuleAccess(module)) return;

                this.currentModule = module;
                
                this.renderModules();
                
                document.getElementById('videoSection').style.display = 'block';
                
                document.getElementById('currentModuleTitle').textContent = module.title;
                document.getElementById('moduleDescription').textContent = module.description;
                document.getElementById('moduleDuration').textContent = module.duration || 'N/A';
                document.getElementById('moduleTier').textContent = module.required_tier;
                
                const isCompleted = this.userProgress[module.id]?.completed;
                document.getElementById('moduleStatus').textContent = isCompleted ? 'Completed' : 'In Progress';
                document.getElementById('completeModule').style.display = isCompleted ? 'none' : 'block';

                this.loadVideoPlayer(module.video_url);
                await this.trackModuleAccess(module.id);
            }

            loadVideoPlayer(videoUrl) {
                const videoPlayer = document.getElementById('videoPlayer');
                
                if (!videoUrl) {
                    videoPlayer.innerHTML = `
                        <div class="video-placeholder">
                            <div class="placeholder-content">
                                <div class="lock-icon">üé¨</div>
                                <h3>Video Content</h3>
                                <p>Video URL not configured</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                videoPlayer.innerHTML = '';

                const muxPlayer = document.createElement('mux-player');
                muxPlayer.setAttribute('stream-type', 'on-demand');
                muxPlayer.setAttribute('playback-id', this.extractPlaybackId(videoUrl));
                muxPlayer.setAttribute('controls', '');
                muxPlayer.style.width = '100%';
                muxPlayer.style.height = '100%';

                videoPlayer.appendChild(muxPlayer);
            }

            extractPlaybackId(videoUrl) {
                const match = videoUrl.match(/(?:mux\.com\/|playback_id=)([a-zA-Z0-9]+)/);
                return match ? match[1] : videoUrl;
            }

            async trackModuleAccess(moduleId) {
                try {
                    const { error } = await supabase
                        .from('user_activity')
                        .insert([{
                            user_id: this.currentUser.id,
                            activity_type: 'module_access',
                            module_id: moduleId,
                            course_id: this.currentCourse.id,
                            metadata: { module_title: this.currentModule.title }
                        }]);

                    if (error) throw error;

                    await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: this.currentUser.id,
                            module_id: moduleId,
                            last_accessed: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,module_id'
                        });

                    await this.loadUserActivity();
                    
                } catch (error) {
                    console.error('Error tracking module access:', error);
                }
            }

            async markModuleComplete() {
                if (!this.currentModule) return;

                try {
                    const { error } = await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: this.currentUser.id,
                            module_id: this.currentModule.id,
                            completed: true,
                            progress_percentage: 100,
                            completed_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,module_id'
                        });

                    if (error) throw error;

                    await supabase
                        .from('user_activity')
                        .insert([{
                            user_id: this.currentUser.id,
                            activity_type: 'module_complete',
                            module_id: this.currentModule.id,
                            course_id: this.currentCourse.id,
                            metadata: { module_title: this.currentModule.title }
                        }]);

                    await this.loadUserProgress();
                    await this.loadUserActivity();
                    this.updateProgress();
                    this.renderModules();

                    document.getElementById('moduleStatus').textContent = 'Completed';
                    document.getElementById('completeModule').style.display = 'none';

                    this.showMessage('üéâ Module marked as complete!', 'success');
                    
                } catch (error) {
                    console.error('Error marking module complete:', error);
                    this.showMessage('‚ùå Error completing module: ' + error.message, 'error');
                }
            }

            previousModule() {
                const currentIndex = this.modules.findIndex(m => m.id === this.currentModule.id);
                if (currentIndex > 0) {
                    const prevModule = this.modules[currentIndex - 1];
                    if (this.hasModuleAccess(prevModule)) {
                        this.selectModule(prevModule.id);
                    }
                }
            }

            nextModule() {
                const currentIndex = this.modules.findIndex(m => m.id === this.currentModule.id);
                if (currentIndex < this.modules.length - 1) {
                    const nextModule = this.modules[currentIndex + 1];
                    if (this.hasModuleAccess(nextModule)) {
                        this.selectModule(nextModule.id);
                    }
                }
            }

            // DOWNLOADS RENDERING
            renderDownloads() {
                const downloadsList = document.getElementById('downloadsList');
                if (!downloadsList) return;

                downloadsList.innerHTML = this.downloads.map(download => {
                    const hasAccess = this.hasDownloadAccess(download);
                    
                    return `
                        <div class="download-item ${!hasAccess ? 'locked' : ''}">
                            <div class="download-info">
                                <h4>${download.title} ${!hasAccess ? 'üîí' : ''}</h4>
                                <span class="file-size">${download.file_size}</span>
                            </div>
                            <div class="download-actions">
                                ${!hasAccess ? 
                                    '<button class="btn-secondary" disabled>Premium Required</button>' :
                                    `<a href="${download.file_url}" target="_blank" class="cta-button">Download</a>`
                                }
                            </div>
                            ${!hasAccess ? 
                                '<div class="premium-lock-message">Upgrade to Premium to download this resource</div>' : 
                                ''
                            }
                        </div>
                    `;
                }).join('');
            }

            // PROGRESS TRACKING
            getCourseProgress(courseId) {
                const courseModules = this.modules.filter(m => m.course_id === courseId);
                const completedModules = courseModules.filter(module => 
                    this.userProgress[module.id]?.completed
                ).length;

                return {
                    completed: completedModules,
                    total: courseModules.length,
                    percentage: courseModules.length > 0 ? Math.round((completedModules / courseModules.length) * 100) : 0
                };
            }

            updateProgress() {
                let totalModules = 0;
                let completedModules = 0;

                this.courses.forEach(course => {
                    if (this.hasCourseAccess(course.id)) {
                        const courseProgress = this.getCourseProgress(course.id);
                        completedModules += courseProgress.completed;
                        totalModules += courseProgress.total;
                    }
                });

                const progressPercentage = totalModules > 0 ? Math.round((completedModules / totalModules) * 100) : 0;

                const circle = document.getElementById('completionCircle');
                const percent = document.getElementById('completionPercent');
                const displayProgress = document.getElementById('displayProgress');
                
                const circumference = 339.292;
                const offset = circumference - (progressPercentage / 100) * circumference;
                
                if (circle) circle.style.strokeDashoffset = offset;
                if (percent) percent.textContent = progressPercentage + '%';
                if (displayProgress) displayProgress.textContent = progressPercentage + '%';

                this.renderCourseProgressList();
            }

            renderCourseProgressList() {
                const container = document.getElementById('courseProgressList');
                if (!container) return;

                container.innerHTML = this.courses.map(course => {
                    if (!this.hasCourseAccess(course.id)) return '';

                    const progress = this.getCourseProgress(course.id);
                    
                    return `
                        <div class="course-progress-item">
                            <div class="course-progress-info">
                                <h4>${course.title}</h4>
                                <div class="course-progress-stats">
                                    <span>${progress.completed} of ${progress.total} modules</span>
                                    <span>${progress.percentage}% complete</span>
                                </div>
                            </div>
                            <div class="course-progress-bar">
                                <div class="course-progress-fill" style="width: ${progress.percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderUserActivity() {
                const container = document.getElementById('userActivityList');
                if (!container) return;

                if (this.userActivity.length === 0) {
                    container.innerHTML = '<div class="activity-item">No recent activity</div>';
                    return;
                }

                container.innerHTML = this.userActivity.map(activity => {
                    let activityText = '';
                    switch (activity.activity_type) {
                        case 'module_access':
                            activityText = `Started watching: ${activity.metadata?.module_title || 'a module'}`;
                            break;
                        case 'module_complete':
                            activityText = `Completed: ${activity.metadata?.module_title || 'a module'}`;
                            break;
                        case 'course_purchase':
                            activityText = `Purchased a course`;
                            break;
                        default:
                            activityText = 'Activity recorded';
                    }

                    return `
                        <div class="activity-item">
                            <div>${activityText}</div>
                            <small>${new Date(activity.created_at).toLocaleString()}</small>
                        </div>
                    `;
                }).join('');
            }

            // PAYMENT AND UPGRADE
            canPurchaseCourse(course) {
                const tierLevel = { 'basic': 1, 'premium': 2 };
                const userTierLevel = tierLevel[this.userProfile?.subscription_tier] || 1;
                const courseTierLevel = tierLevel[course.required_tier] || 1;
                
                return userTierLevel >= courseTierLevel && !this.hasCourseAccess(course.id);
            }

            async purchaseCourse(courseId) {
                const course = this.courses.find(c => c.id === courseId);
                if (!course) return;

                try {
                    const { data, error } = await supabase
                        .from('user_courses')
                        .insert([{
                            user_id: this.currentUser.id,
                            course_id: courseId,
                            payment_status: 'completed',
                            purchased_price: course.price
                        }]);

                    if (error) throw error;

                    await supabase
                        .from('user_activity')
                        .insert([{
                            user_id: this.currentUser.id,
                            activity_type: 'course_purchase',
                            course_id: courseId,
                            metadata: { course_title: course.title, price: course.price }
                        }]);

                    const tierLevel = { 'basic': 1, 'premium': 2 };
                    const currentTierLevel = tierLevel[this.userProfile.subscription_tier] || 1;
                    const courseTierLevel = tierLevel[course.required_tier] || 1;
                    
                    if (courseTierLevel > currentTierLevel) {
                        await supabase
                            .from('profiles')
                            .update({ subscription_tier: course.required_tier })
                            .eq('id', this.currentUser.id);
                    }

                    this.showMessage('üéâ Course purchased successfully! You now have access.', 'success');
                    await this.loadUserData();
                    await this.loadUserCourses();
                    await this.loadUserActivity();
                    this.renderCourses();
                    this.checkUpgradePrompt();
                    
                } catch (error) {
                    console.error('Error purchasing course:', error);
                    this.showMessage('‚ùå Purchase failed: ' + error.message, 'error');
                }
            }

            async processUpgrade() {
                try {
                    const { error } = await supabase
                        .from('profiles')
                        .update({ subscription_tier: 'premium' })
                        .eq('id', this.currentUser.id);

                    if (error) throw error;

                    await supabase
                        .from('user_activity')
                        .insert([{
                            user_id: this.currentUser.id,
                            activity_type: 'tier_upgrade',
                            metadata: { from_tier: 'basic', to_tier: 'premium' }
                        }]);

                    this.showMessage('üéâ Successfully upgraded to Premium!', 'success');
                    await this.loadUserData();
                    await this.loadUserActivity();
                    this.checkUpgradePrompt();
                    
                    if (this.currentCourse) {
                        this.renderModules();
                        this.renderDownloads();
                    }
                    
                    closeUpgradeModal();
                    
                } catch (error) {
                    console.error('Error upgrading tier:', error);
                    this.showMessage('‚ùå Upgrade failed: ' + error.message, 'error');
                }
            }

            // UTILITY METHODS
            showMessage(message, type) {
                const messageEl = document.createElement('div');
                messageEl.className = `form-message ${type}`;
                messageEl.textContent = message;
                messageEl.style.position = 'fixed';
                messageEl.style.top = '100px';
                messageEl.style.right = '20px';
                messageEl.style.zIndex = '3000';
                messageEl.style.padding = '12px 20px';
                messageEl.style.borderRadius = '6px';
                messageEl.style.color = 'white';
                messageEl.style.fontWeight = 'bold';
                messageEl.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                
                if (type === 'success') {
                    messageEl.style.background = 'linear-gradient(135deg, #00b09b, #96c93d)';
                } else if (type === 'error') {
                    messageEl.style.background = 'linear-gradient(135deg, #ff416c, #ff4b2b)';
                } else {
                    messageEl.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                }
                
                document.body.appendChild(messageEl);
                
                setTimeout(() => {
                    messageEl.remove();
                }, 5000);
            }

            async logout() {
                console.log('Logout method called');
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    console.log('Logout successful, redirecting...');
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    this.showMessage('Logout failed: ' + error.message, 'error');
                }
            }

            openMobileMenu() {
                document.getElementById('mobileMenu').classList.add('active');
                document.getElementById('mobileMenuOverlay').classList.add('active');
                document.body.classList.add('menu-open');
            }
        }

        // Global functions
        function backToCourses() {
            document.getElementById('coursesView').style.display = 'block';
            document.getElementById('courseDetailsView').style.display = 'none';
            document.getElementById('videoSection').style.display = 'none';
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('active');
            document.getElementById('mobileMenuOverlay').classList.remove('active');
            document.body.classList.remove('menu-open');
        }

        function processUpgrade(method) {
            if (method === 'manual') {
                const phoneNumber = '7504704502';
                const message = `Hello! I'd like to upgrade my account tier. My email: ${window.lmsManager?.currentUser?.email || 'Not logged in'}`;
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                return;
            }
            window.lmsManager.processUpgrade();
        }

        // Initialize LMS Manager
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase Configuration
            const SUPABASE_URL = 'https://usooclimfkregwrtmdki.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzb29jbGltZmtyZWd3cnRtZGtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0Nzg2MTEsImV4cCI6MjA3OTA1NDYxMX0.43Wy4GS_DSx4IWXmFKg5wz0YwmV7lsadWcm0ysCcfe0';

            window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            window.lmsManager = new LMSManager();
        });

        // Auth state listener
        supabase.auth.onAuthStateChange((event, session) => {
            if (window.lmsManager) {
                window.lmsManager.checkAuthState();
            }
        });
    </script>
</body>
</html>
